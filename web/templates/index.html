<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NETGEN Pro - Complete Advanced Traffic Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <!-- Socket.IO served by Flask-SocketIO (no CDN dependency) -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="/static/js/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-card: #1a1a1a;
            --bg-hover: #222222;
            --accent-cyan: #00ffff;
            --accent-magenta: #ff00ff;
            --accent-yellow: #ffff00;
            --accent-green: #00ff00;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --text-dim: #444444;
            --border: #333333;
            --success: #00ff00;
            --error: #ff0000;
            --warning: #ff9900;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridScroll 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gridScroll {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: auto 1fr;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        header {
            grid-column: 1 / -1;
            border: 2px solid var(--accent-cyan);
            padding: 20px 30px;
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
            animation: scanline 3s linear infinite;
        }

        @keyframes scanline {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin: 0;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-top: 5px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .header-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .sidebar-left, .sidebar-right {
            background: var(--bg-secondary);
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar-left {
            border-right: 2px solid var(--border);
        }

        .sidebar-right {
            border-left: 2px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .main-content {
            overflow-y: auto;
            padding: 20px;
        }

        .section-header {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .status-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 15px;
            transition: all 0.3s;
        }

        .status-card:hover {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        }

        .status-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .status-running {
            color: var(--success);
            text-shadow: 0 0 10px var(--success);
        }

        .status-stopped {
            color: var(--text-dim);
        }

        .control-panel {
            background: var(--bg-card);
            border: 2px solid var(--border);
            padding: 25px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 12px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border-color: var(--accent-cyan);
            font-weight: 700;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .preset-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px 8px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            text-align: center;
            transition: all 0.2s;
        }

        .preset-btn.active {
            border-color: var(--accent-cyan);
            background: var(--accent-cyan);
            color: var(--bg-primary);
            font-weight: 700;
        }

        .profile-list {
            display: grid;
            gap: 10px;
        }

        .profile-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 15px;
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .profile-name {
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .profile-details {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 10px;
        }

        .profile-rate {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-magenta);
        }

        .profile-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .profile-advanced {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .adv-control {
            display: flex;
            flex-direction: column;
        }

        .adv-control label {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-bottom: 5px;
        }

        .adv-control select,
        .adv-control input {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
        }

        .qos-selector {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            min-width: 120px;
        }

        input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            cursor: pointer;
            position: relative;
        }

        input[type="checkbox"]:checked {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }

        input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--bg-primary);
            font-weight: 700;
        }

        .toggle-advanced {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            transition: all 0.2s;
        }

        .toggle-advanced:hover {
            border-color: var(--accent-yellow);
            color: var(--accent-yellow);
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-start, .btn-stop {
            padding: 15px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            cursor: pointer;
            border: 2px solid;
            transition: all 0.3s;
        }

        .btn-start {
            background: transparent;
            color: var(--success);
            border-color: var(--success);
        }

        .btn-start:hover:not(:disabled) {
            background: var(--success);
            color: var(--bg-primary);
            box-shadow: 0 0 20px var(--success);
        }

        .btn-stop {
            background: transparent;
            color: var(--error);
            border-color: var(--error);
        }

        .btn-stop:hover:not(:disabled) {
            background: var(--error);
            color: var(--text-primary);
            box-shadow: 0 0 20px var(--error);
        }

        .btn-start:disabled, .btn-stop:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .stats-panel {
            background: var(--bg-card);
            border: 2px solid var(--border);
            padding: 25px;
        }

        .total-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            padding: 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent-cyan);
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .stat-value.warning {
            color: var(--warning);
            text-shadow: 0 0 10px rgba(255, 153, 0, 0.5);
        }

        .stat-value.error {
            color: var(--error);
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 15px;
        }

        .stat-profile-name {
            font-weight: 700;
            color: var(--accent-magenta);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.8rem;
        }

        .graph-container {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 20px;
            margin: 20px;
            height: 300px;
        }

        .saved-profile-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 12px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .saved-profile-item:hover {
            border-color: var(--accent-cyan);
        }

        .saved-profile-name {
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .saved-profile-desc {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .saved-profile-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 0.65rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
        }

        .btn-small:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .btn-small.danger:hover {
            border-color: var(--error);
            color: var(--error);
        }

        .history-list {
            display: grid;
            gap: 10px;
            padding: 20px;
        }

        .history-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 12px;
            cursor: pointer;
        }

        .history-item:hover {
            border-color: var(--accent-magenta);
        }

        .history-name {
            font-weight: 700;
            color: var(--accent-magenta);
        }

        .history-time {
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        .history-stats {
            font-size: 0.7rem;
            color: var(--text-secondary);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-cyan);
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .modal-close:hover {
            border-color: var(--error);
            color: var(--error);
        }

        .feature-badge {
            display: inline-block;
            background: var(--accent-yellow);
            color: var(--bg-primary);
            padding: 2px 6px;
            font-size: 0.6rem;
            font-weight: 700;
            margin-left: 5px;
            text-transform: uppercase;
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 10px 15px;
            font-size: 0.7rem;
            z-index: 100;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: var(--error);
            box-shadow: 0 0 10px var(--error);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
        }

        .hidden {
            display: none !important;
        }

        .advanced-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 15px;
            margin-top: 20px;
        }

        .advanced-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .advanced-header:hover {
            color: var(--accent-yellow);
        }

        .advanced-content {
            margin-top: 15px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border-color: var(--accent-cyan);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="header-content">
                <div>
                    <h1>NETGEN PRO <span class="feature-badge">ADVANCED</span></h1>
                    <div class="subtitle">Network Traffic Generator - Complete Feature Set</div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="openSaveProfileModal()">üíæ Save</button>
                    <button class="header-btn" onclick="exportHistory('csv')">üìä Export</button>
                    <button class="header-btn" onclick="openSettingsModal()">‚öôÔ∏è Settings</button>
                    <button class="header-btn" onclick="openFeaturesModal()">üöÄ Features</button>
                </div>
            </div>
        </header>

        <div class="sidebar-left">
            <div class="section-header">üíæ Saved Profiles</div>
            <button class="header-btn" style="width:100%;margin-bottom:15px;" onclick="loadSavedProfiles()">üîÑ Refresh</button>
            <div id="saved-profiles-list">
                <div style="color:var(--text-dim);text-align:center;padding:20px;font-size:0.8rem;">
                    No saved profiles yet
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-label">Status</div>
                    <div class="status-value" id="generator-status">OFFLINE</div>
                </div>
                <div class="status-card">
                    <div class="status-label">Source IP</div>
                    <div class="status-value" id="source-ip">Loading...</div>
                </div>
                <div class="status-card">
                    <div class="status-label">Destination</div>
                    <div class="status-value" id="dest-ip">-</div>
                </div>
                <div class="status-card">
                    <div class="status-label">Elapsed</div>
                    <div class="status-value" id="elapsed-time">0s</div>
                </div>
                <div class="status-card">
                    <div class="status-label">Packet Loss</div>
                    <div class="status-value" id="packet-loss">0%</div>
                </div>
                <div class="status-card">
                    <div class="status-label">Avg Latency</div>
                    <div class="status-value" id="avg-latency">0ms</div>
                </div>
            </div>

            <div class="control-panel">
                <div class="section-header">‚ö° Configuration</div>

                <div class="mode-selector">
                    <button class="mode-btn active" onclick="setMode('single')">Single Endpoint</button>
                    <button class="mode-btn" onclick="setMode('multi')">Multiple Endpoints</button>
                </div>

                <div id="single-mode">
                    <div class="form-group">
                        <label for="test-name">Test Name</label>
                        <input type="text" id="test-name" value="Advanced Test">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="destination">Destination IP</label>
                            <input type="text" id="destination" value="8.8.8.8" onblur="autoDetectInterface()">
                        </div>
                        <div class="form-group">
                            <label for="duration">Duration (seconds)</label>
                            <input type="number" id="duration" placeholder="Indefinite">
                        </div>
                    </div>

                    <!-- Auto-Detection Result -->
                    <div id="auto-detect-result" style="display:none; padding:12px; background:var(--bg-primary); 
                         border-left:4px solid var(--accent-cyan); margin:10px 0; font-size:0.9rem;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <strong style="color:var(--accent-cyan);">‚ú® Auto-Detected:</strong><br>
                                <span style="color:var(--text-secondary);">Interface:</span> <strong id="auto-interface">-</strong><br>
                                <span style="color:var(--text-secondary);">Source IP:</span> <strong id="auto-source">-</strong>
                            </div>
                            <button onclick="acceptAutoDetection()" style="background:var(--accent-cyan); color:var(--bg-primary); 
                                    border:none; padding:8px 16px; cursor:pointer; font-weight:700; font-size:0.85rem;">
                                ‚úì Use This
                            </button>
                        </div>
                        <small style="color:var(--text-dim); display:block; margin-top:8px;">
                            Change in Advanced Options ‚Üí Source/Interface if needed
                        </small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="mtu">MTU (Bytes)</label>
                            <input type="number" id="mtu" value="1500" min="576" max="9000">
                            <small>Standard: 1500 | Jumbo: 9000 | WSL: 1280</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="enable-capture">
                                Enable Packet Capture (.pcap)
                            </label>
                        </div>
                    </div>

                    <!-- Advanced Global Options -->
                    <div class="advanced-section">
                        <div class="advanced-header" onclick="toggleSection('global-advanced')">
                            <span>üî¨ Advanced Options</span>
                            <span id="global-advanced-toggle">‚ñº</span>
                        </div>
                        <div class="advanced-content" id="global-advanced-content">
                            <div class="tab-buttons">
                                <button class="tab-btn active" onclick="switchTab('impairment')">Network Impairment</button>
                                <button class="tab-btn" onclick="switchTab('measurement')">Measurement</button>
                                <button class="tab-btn" onclick="switchTab('source')">Source/Interface</button>
                                <button class="tab-btn" onclick="switchTab('coordinator')">Coordinator</button>
                            </div>

                            <!-- Impairment Tab -->
                            <div class="tab-content active" id="impairment-tab">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="inject-loss">Inject Packet Loss (%)</label>
                                        <input type="number" id="inject-loss" value="0" min="0" max="100" step="0.1">
                                        <small>Simulate packet loss (0-100%)</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="inject-latency">Inject Latency (ms)</label>
                                        <input type="number" id="inject-latency" value="0" min="0" max="1000">
                                        <small>Add artificial delay (0-1000ms)</small>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="inject-jitter">Inject Jitter (ms)</label>
                                        <input type="number" id="inject-jitter" value="0" min="0" max="100">
                                        <small>Random latency variation</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="inject-corruption">Inject Corruption (%)</label>
                                        <input type="number" id="inject-corruption" value="0" min="0" max="100" step="0.1">
                                        <small>Corrupt random bytes</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Measurement Tab -->
                            <div class="tab-content" id="measurement-tab">
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="measure-latency">
                                        Enable Latency Measurement
                                    </label>
                                    <small>Embed timestamps for RTT tracking</small>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="track-loss">
                                        Enable Packet Loss Tracking
                                    </label>
                                    <small>Monitor packet delivery rate</small>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="calculate-jitter">
                                        Calculate Jitter Statistics
                                    </label>
                                    <small>Track latency variation</small>
                                </div>
                            </div>

                            <!-- Source/Interface Tab -->
                            <div class="tab-content" id="source-tab">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="source-ip">Source IP (Optional)</label>
                                        <input type="text" id="source-ip" placeholder="Auto-detect">
                                        <small>Leave blank for automatic selection</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="source-interface">Network Interface (Optional)</label>
                                        <select id="source-interface">
                                            <option value="">Auto-detect</option>
                                        </select>
                                        <small>Bind to specific NIC</small>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <button class="btn" onclick="loadInterfaces()" style="width:auto;">üîÑ Refresh Interfaces</button>
                                    <div id="interface-info" style="margin-top:10px;padding:10px;background:var(--bg-primary);border:1px solid var(--border);font-size:0.75rem;max-height:150px;overflow-y:auto;">
                                        <div style="color:var(--text-dim);">Click Refresh to load available interfaces</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Coordinator Tab -->
                            <div class="tab-content" id="coordinator-tab">
                                <div class="form-group">
                                    <label for="coordinator-status">Coordinator Status</label>
                                    <div id="coordinator-status" style="padding:10px;background:var(--bg-primary);border:1px solid var(--border);font-size:0.8rem;">
                                        Not Connected
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="cluster-select">Select Cluster</label>
                                    <select id="cluster-select">
                                        <option value="">No Clusters Available</option>
                                    </select>
                                    <small>Requires coordinator connection</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Traffic Presets</label>
                        <div class="preset-grid" id="preset-grid"></div>
                    </div>

                    <div class="section-header">üéØ Traffic Profiles</div>
                    <div class="profile-list" id="profile-list"></div>
                </div>

                <div id="multi-mode" style="display:none;">
                    <div class="multi-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: var(--bg-primary);">
                        <button class="btn" onclick="addMultiEndpoint()" style="width: auto; margin: 0;">‚ûï Add Endpoint</button>
                        <span id="multi-endpoint-count" style="color: var(--text-secondary);">0 endpoints</span>
                    </div>
                    <div id="endpoint-list"></div>
                </div>

                <div class="btn-group">
                    <button class="btn-start" id="start-btn">Start Generation</button>
                    <button class="btn-stop" id="stop-btn" disabled>Stop Generation</button>
                </div>
            </div>

            <div class="stats-panel">
                <div class="section-header">üìä Real-Time Statistics</div>
                <div class="total-stats" id="total-stats" style="display:none;">
                    <div class="stat-item">
                        <div class="stat-label">Mbps</div>
                        <div class="stat-value" id="total-mbps">0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Packets</div>
                        <div class="stat-value" id="total-packets">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">PPS</div>
                        <div class="stat-value" id="total-pps">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Loss</div>
                        <div class="stat-value warning" id="total-loss">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Errors</div>
                        <div class="stat-value error" id="total-errors">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Latency</div>
                        <div class="stat-value" id="total-latency">0ms</div>
                    </div>
                </div>
                <div class="stats-grid" id="stats-grid"></div>
            </div>
        </div>

        <div class="sidebar-right">
            <div class="section-header">üìà Bandwidth</div>
            <div class="graph-container">
                <canvas id="bandwidth-chart"></canvas>
            </div>
            <div class="section-header">üìö History</div>
            <div class="history-list" id="history-list">
                <div style="color:var(--text-dim);text-align:center;padding:20px;font-size:0.8rem;">
                    No history yet
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="save-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeSaveModal()">√ó</button>
            <div class="modal-header">üíæ Save Profile</div>
            <div class="form-group">
                <label>Profile Name</label>
                <input type="text" id="profile-name">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="profile-desc">
            </div>
            <div class="btn-group">
                <button class="btn-start" onclick="saveProfile()">Save</button>
                <button class="btn-stop" onclick="closeSaveModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
            <div class="modal-header">‚öôÔ∏è Settings</div>
            <div class="form-group">
                <label><input type="checkbox" id="auto-save"> Auto-save test history</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="auto-capture"> Enable capture by default</label>
            </div>
            <div class="btn-group">
                <button class="btn-start" onclick="saveSettings()">Save</button>
                <button class="btn-stop" onclick="closeSettingsModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="features-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeFeaturesModal()">√ó</button>
            <div class="modal-header">üöÄ Advanced Features Status</div>
            <div id="features-content" style="font-size:0.85rem;">
                <p>Loading features...</p>
            </div>
        </div>
    </div>

    <div class="connection-status">
        <div class="status-dot disconnected" id="conn-dot"></div>
        <span id="conn-text">DISCONNECTED</span>
    </div>

    <script>
        // Socket.IO connection with proper configuration
        const socket = io({
            transports: ['websocket', 'polling'],
            upgrade: true,
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: 10,
            timeout: 20000,
            pingTimeout: 60000,
            pingInterval: 25000
        });
        
        let currentPreset = null;
        let presets = {};
        let isRunning = false;
        let startTime = null;
        let timerInterval = null;
        let chart = null;
        let advancedFeatures = {enabled: false};

        // Connection status handlers
        socket.on('connect', () => {
            console.log('‚úÖ Socket.IO connected');
            updateConnectionStatus(true);
        });

        socket.on('disconnect', (reason) => {
            console.log('‚ùå Socket.IO disconnected:', reason);
            updateConnectionStatus(false);
        });

        socket.on('connect_error', (error) => {
            console.error('Socket.IO connection error:', error);
            updateConnectionStatus(false);
        });

        socket.on('reconnect', (attemptNumber) => {
            console.log('üîÑ Socket.IO reconnected after', attemptNumber, 'attempts');
            updateConnectionStatus(true);
        });

        socket.on('reconnect_attempt', (attemptNumber) => {
            console.log('üîÑ Reconnection attempt', attemptNumber);
        });

        socket.on('reconnect_error', (error) => {
            console.error('Reconnection error:', error);
        });

        socket.on('reconnect_failed', () => {
            console.error('‚ùå Failed to reconnect');
            updateConnectionStatus(false);
        });

        function updateConnectionStatus(connected) {
            const dot = document.getElementById('conn-dot');
            const text = document.getElementById('conn-text');
            if (connected) {
                dot.className = 'status-dot connected';
                text.textContent = 'CONNECTED';
                text.style.color = '#4caf50';
            } else {
                dot.className = 'status-dot disconnected';
                text.textContent = 'DISCONNECTED';
                text.style.color = '#f44336';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            loadPresets();
            getStatus();
            loadSavedProfiles();
            loadHistory();
            loadAdvancedFeatures();
            checkCoordinator();
            setInterval(loadHistory, 30000);
        });

        function initChart() {
            const ctx = document.getElementById('bandwidth-chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Mbps',
                        data: [],
                        borderColor: '#00ffff',
                        backgroundColor: 'rgba(0,255,255,0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        function updateChart(mbps, elapsed) {
            if (!chart) return;
            if (chart.data.labels.length > 60) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.data.labels.push(elapsed + 's');
            chart.data.datasets[0].data.push(mbps);
            chart.update('none');
        }

        function startTimer() {
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('elapsed-time').textContent = elapsed + 's';
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
            startTime = null;
        }

        function setMode(mode) {
            document.getElementById('single-mode').style.display = mode === 'single' ? 'block' : 'none';
            document.getElementById('multi-mode').style.display = mode === 'multi' ? 'block' : 'none';
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Multiple Endpoints functionality
        let multiEndpoints = [];
        let multiEndpointCounter = 0;

        function addMultiEndpoint() {
            multiEndpointCounter++;
            const endpoint = {
                id: multiEndpointCounter,
                ip: '192.168.1.' + multiEndpointCounter,
                port: 5000,
                rate: 100,
                protocol: 'udp',
                packet_size: 1400,
                dscp: 0,
                duration: null,
                preset: ''
            };
            multiEndpoints.push(endpoint);
            renderMultiEndpoints();
        }

        function removeMultiEndpoint(id) {
            multiEndpoints = multiEndpoints.filter(e => e.id !== id);
            renderMultiEndpoints();
        }

        function updateMultiEndpoint(id, field, value) {
            const endpoint = multiEndpoints.find(e => e.id === id);
            if (endpoint) {
                endpoint[field] = value;
                
                // Handle custom bandwidth preset selection
                if (field === 'preset' && value === 'custom_bandwidth') {
                    const rate = prompt('Enter custom bandwidth in Mbps (e.g., 250):', '100');
                    if (rate === null || rate === '') {
                        // User cancelled - clear preset
                        endpoint.preset = '';
                        return;
                    }
                    
                    const rateNum = parseFloat(rate);
                    if (isNaN(rateNum) || rateNum <= 0) {
                        alert('Please enter a valid positive number for bandwidth');
                        endpoint.preset = '';
                        return;
                    }
                    
                    // Store custom rate with endpoint
                    endpoint.custom_rate = rateNum;
                    
                    // Update the custom preset with user-defined rate
                    presets['custom_bandwidth'].profiles[0].rate = rateNum;
                    presets['custom_bandwidth'].total_rate = rateNum;
                    presets['custom_bandwidth'].profiles[0].name = `Custom-${rateNum}M`;
                }
            }
        }

        function renderMultiEndpoints() {
            const list = document.getElementById('endpoint-list');
            list.innerHTML = '';
            
            multiEndpoints.forEach(ep => {
                const card = document.createElement('div');
                card.style.cssText = 'background: var(--bg-primary); border: 1px solid var(--border); padding: 15px; margin-bottom: 15px; position: relative;';
                
                // Build preset options
                let presetOptions = '<option value="">Simple Profile (Manual Config)</option>';
                Object.keys(presets).forEach(key => {
                    const selected = ep.preset === key ? 'selected' : '';
                    presetOptions += `<option value="${key}" ${selected}>${presets[key].name}</option>`;
                });
                
                // Build the card content
                let cardHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 700; color: var(--accent-cyan);">Endpoint ${ep.id}</span>
                        <button onclick="removeMultiEndpoint(${ep.id})" style="background: #ff4444; color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 0.8rem;">‚úï Remove</button>
                    </div>
                    
                    <!-- Traffic Profile Selection -->
                    <div style="margin-bottom: 15px; padding: 12px; background: var(--bg-secondary); border-left: 3px solid var(--accent-magenta); border-radius: 4px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-weight: 600; color: var(--accent-magenta);">‚ö° Traffic Profile</label>
                            <select onchange="updateMultiEndpoint(${ep.id}, 'preset', this.value); renderMultiEndpoints();" style="width: 100%;">
                                ${presetOptions}
                            </select>
                            <small style="display:block; margin-top:5px; color: var(--text-secondary);">
                                Select a preset for complex traffic patterns, or use "Simple Profile" for manual configuration
                            </small>
                        </div>
                    </div>
                `;
                
                // Show preset info if selected
                if (ep.preset && presets[ep.preset]) {
                    const presetName = ep.preset === 'custom_bandwidth' && ep.custom_rate 
                        ? `‚ö° Custom Bandwidth (${ep.custom_rate} Mbps)`
                        : presets[ep.preset].name;
                    const streamCount = presets[ep.preset].profiles.length;
                    
                    cardHTML += `
                        <div style="margin-bottom: 12px; padding: 10px; background: rgba(139, 92, 246, 0.15); border-left: 3px solid var(--accent-magenta); border-radius: 4px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-size: 1.2em;">üìä</span>
                                <strong style="color: var(--accent-magenta);">Using: ${presetName}</strong>
                            </div>
                            <small style="color: var(--text-secondary);">
                                This preset will generate <strong>${streamCount} traffic stream(s)</strong> to ${ep.ip || 'this endpoint'}
                            </small>
                        </div>
                    `;
                }
                
                // Basic fields (always shown)
                cardHTML += `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group">
                            <label>üéØ IP Address</label>
                            <input type="text" value="${ep.ip || ''}" placeholder="e.g., 10.0.3.200" 
                                   onchange="updateMultiEndpoint(${ep.id}, 'ip', this.value)">
                        </div>
                        <div class="form-group">
                            <label>üîå Port</label>
                            <input type="number" value="${ep.port || 5000}" 
                                   onchange="updateMultiEndpoint(${ep.id}, 'port', parseInt(this.value))">
                        </div>
                        <div class="form-group">
                            <label>‚è±Ô∏è Duration (seconds)</label>
                            <input type="number" value="${ep.duration || ''}" placeholder="Indefinite" 
                                   onchange="updateMultiEndpoint(${ep.id}, 'duration', this.value ? parseInt(this.value) : null)">
                            <small>Leave empty for indefinite</small>
                        </div>
                `;
                
                // Manual config fields (only if no preset selected)
                if (!ep.preset) {
                    cardHTML += `
                        <div class="form-group">
                            <label>üöÄ Rate (Mbps)</label>
                            <input type="number" value="${ep.rate || 100}" 
                                   onchange="updateMultiEndpoint(${ep.id}, 'rate', parseInt(this.value))">
                        </div>
                        <div class="form-group">
                            <label>üì° Protocol</label>
                            <select onchange="updateMultiEndpoint(${ep.id}, 'protocol', this.value)">
                                <option value="udp" ${ep.protocol === 'udp' ? 'selected' : ''}>UDP</option>
                                <option value="tcp" ${ep.protocol === 'tcp' ? 'selected' : ''}>TCP</option>
                                <option value="icmp" ${ep.protocol === 'icmp' ? 'selected' : ''}>ICMP</option>
                                <option value="http" ${ep.protocol === 'http' ? 'selected' : ''}>HTTP</option>
                                <option value="dns" ${ep.protocol === 'dns' ? 'selected' : ''}>DNS</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üì¶ Packet Size (bytes)</label>
                            <input type="number" value="${ep.packet_size || 1400}" min="64" max="9000" 
                                   onchange="updateMultiEndpoint(${ep.id}, 'packet_size', parseInt(this.value))">
                        </div>
                        <div class="form-group">
                            <label>üè∑Ô∏è DSCP/QoS</label>
                            <select onchange="updateMultiEndpoint(${ep.id}, 'dscp', parseInt(this.value))">
                                <option value="0" ${(ep.dscp || 0) === 0 ? 'selected' : ''}>Best Effort (0)</option>
                                <option value="46" ${ep.dscp === 46 ? 'selected' : ''}>EF - Expedited (46)</option>
                                <option value="34" ${ep.dscp === 34 ? 'selected' : ''}>AF41 (34)</option>
                                <option value="26" ${ep.dscp === 26 ? 'selected' : ''}>AF31 (26)</option>
                                <option value="18" ${ep.dscp === 18 ? 'selected' : ''}>AF21 (18)</option>
                                <option value="10" ${ep.dscp === 10 ? 'selected' : ''}>AF11 (10)</option>
                            </select>
                        </div>
                    `;
                } else {
                    // Preset is selected - show info message
                    cardHTML += `
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <div style="padding: 10px; background: var(--bg-secondary); border-radius: 4px; text-align: center;">
                                <small style="color: var(--text-secondary);">
                                    ‚ÑπÔ∏è Protocol, rate, packet size, and QoS settings come from the selected preset
                                </small>
                            </div>
                        </div>
                    `;
                }
                
                cardHTML += `
                    </div>
                    <div style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
                        <small style="color:var(--text-dim);">
                            <strong>üîç Auto-Detection:</strong> ${ep.ip ? 'Will auto-detect interface for ' + ep.ip : 'Enter IP to enable auto-detection'}
                        </small>
                    </div>
                `;
                
                card.innerHTML = cardHTML;
                list.appendChild(card);
            });
            
            document.getElementById('multi-endpoint-count').textContent = multiEndpoints.length + ' endpoint' + (multiEndpoints.length !== 1 ? 's' : '');
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const toggle = document.getElementById(sectionId + '-toggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñ∂';
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        async function loadPresets() {
            try {
                const res = await fetch('/api/presets');
                if (!res.ok) {
                    console.error('Failed to load presets:', res.status);
                    return;
                }
                presets = await res.json();
                const grid = document.getElementById('preset-grid');
                if (!grid) {
                    console.error('preset-grid element not found');
                    return;
                }
                grid.innerHTML = '';
                Object.entries(presets).forEach(([key, preset]) => {
                    const btn = document.createElement('button');
                    btn.className = 'preset-btn';
                    btn.textContent = preset.name;
                    btn.onclick = () => selectPreset(key, btn);
                    grid.appendChild(btn);
                });
                console.log(`Loaded ${Object.keys(presets).length} presets`);
            } catch (error) {
                console.error('Error loading presets:', error);
                // Still show a message to user
                const grid = document.getElementById('preset-grid');
                if (grid) {
                    grid.innerHTML = '<div style="color:var(--accent-yellow);padding:10px;">‚ö†Ô∏è Failed to load presets. Check console for details.</div>';
                }
            }
        }

        function selectPreset(key, btn) {
            currentPreset = key;
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Handle custom bandwidth preset
            if (key === 'custom_bandwidth') {
                showCustomBandwidthDialog();
            } else {
                renderProfiles();
            }
        }
        
        function showCustomBandwidthDialog() {
            const rate = prompt('Enter custom bandwidth in Mbps (e.g., 250):', '100');
            if (rate === null) {
                // User cancelled - deselect preset
                currentPreset = null;
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                renderProfiles();
                return;
            }
            
            const rateNum = parseFloat(rate);
            if (isNaN(rateNum) || rateNum <= 0) {
                alert('Please enter a valid positive number for bandwidth');
                currentPreset = null;
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                renderProfiles();
                return;
            }
            
            // Update the custom preset with user-defined rate
            presets['custom_bandwidth'].profiles[0].rate = rateNum;
            presets['custom_bandwidth'].total_rate = rateNum;
            presets['custom_bandwidth'].profiles[0].name = `Custom-${rateNum}M`;
            
            renderProfiles();
        }

        function renderProfiles() {
            const list = document.getElementById('profile-list');
            if (!currentPreset) {
                list.innerHTML = '<div style="color:var(--text-dim);padding:20px;text-align:center;">Select preset</div>';
                return;
            }
            list.innerHTML = '';
            presets[currentPreset].profiles.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = 'profile-item';
                div.innerHTML = `
                    <div class="profile-header">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <input type="checkbox" checked data-idx="${idx}">
                            <div>
                                <div class="profile-name">${p.name}</div>
                                <div class="profile-details">${p.protocol.toUpperCase()} ‚Ä¢ ${p.packet_size}B ‚Ä¢ Port ${p.dst_port}</div>
                            </div>
                        </div>
                        <div class="profile-rate">${p.rate} Mbps</div>
                    </div>
                    <div class="profile-advanced">
                        <div class="adv-control">
                            <label>QoS/DSCP</label>
                            <select class="qos-select" data-idx="${idx}">
                                <option value="0">BE (0)</option>
                                <option value="46" selected>EF (46)</option>
                                <option value="34">AF41 (34)</option>
                                <option value="26">AF31 (26)</option>
                                <option value="18">AF21 (18)</option>
                                <option value="10">AF11 (10)</option>
                            </select>
                        </div>
                        <div class="adv-control">
                            <label>Payload</label>
                            <select class="payload-select" data-idx="${idx}">
                                <option value="random">Random</option>
                                <option value="zeros">Zeros</option>
                                <option value="ones">Ones</option>
                                <option value="increment">Increment</option>
                            </select>
                        </div>
                        <div class="adv-control">
                            <label>TCP Flags</label>
                            <select class="tcpflags-select" data-idx="${idx}">
                                <option value="SYN" selected>SYN</option>
                                <option value="ACK">ACK</option>
                                <option value="PSH|ACK">PSH+ACK</option>
                                <option value="RST">RST</option>
                                <option value="FIN">FIN</option>
                            </select>
                        </div>
                        <div class="adv-control">
                            <label>
                                <input type="checkbox" class="burst-check" data-idx="${idx}">
                                Burst Mode
                            </label>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        document.getElementById('start-btn').onclick = async () => {
            // Determine which mode is active
            const singleMode = document.getElementById('single-mode').style.display !== 'none';
            const multiMode = document.getElementById('multi-mode').style.display !== 'none';
            
            const testName = document.getElementById('test-name').value;
            const duration = document.getElementById('duration').value;
            const mtu = parseInt(document.getElementById('mtu').value);
            const capture = document.getElementById('enable-capture').checked;
            
            // Network impairment (global)
            const injectLoss = parseFloat(document.getElementById('inject-loss').value) || 0;
            const injectLatency = parseInt(document.getElementById('inject-latency').value) || 0;
            const injectJitter = parseInt(document.getElementById('inject-jitter').value) || 0;
            const injectCorruption = parseFloat(document.getElementById('inject-corruption').value) || 0;
            
            // Measurement (global)
            const measureLatency = document.getElementById('measure-latency').checked;
            const trackLoss = document.getElementById('track-loss').checked;
            const calculateJitter = document.getElementById('calculate-jitter').checked;
            
            // Source/Interface (global)
            const sourceIp = document.getElementById('source-ip').value;
            const sourceInterface = document.getElementById('source-interface').value;

            let profiles = [];
            let dest = null;

            if (singleMode) {
                // SINGLE ENDPOINT MODE
                dest = document.getElementById('destination').value;
                
                if (!dest || !currentPreset) {
                    alert('Please enter destination IP and select a preset');
                    return;
                }

                profiles = presets[currentPreset].profiles.map((p, idx) => {
                    const cb = document.querySelector(`input[data-idx="${idx}"]`);
                    const qos = document.querySelector(`.qos-select[data-idx="${idx}"]`);
                    const payload = document.querySelector(`.payload-select[data-idx="${idx}"]`);
                    const tcpflags = document.querySelector(`.tcpflags-select[data-idx="${idx}"]`);
                    const burst = document.querySelector(`.burst-check[data-idx="${idx}"]`);
                    
                    return {
                        ...p,
                        dst_ip: dest,
                        enabled: cb.checked,
                        dscp: parseInt(qos.value),
                        payload_pattern: payload.value,
                        tcp_flags: tcpflags.value,
                        burst_mode: burst.checked,
                        measure_latency: measureLatency,
                        src_ip: sourceIp || null,
                        interface: sourceInterface || null,
                        inject_loss_percent: injectLoss,
                        inject_latency_ms: injectLatency,
                        inject_jitter_ms: injectJitter,
                        inject_corruption_percent: injectCorruption
                    };
                });
                
            } else if (multiMode) {
                // MULTIPLE ENDPOINTS MODE
                if (multiEndpoints.length === 0) {
                    alert('Please add at least one endpoint');
                    return;
                }
                
                // Use first endpoint's IP as "dest" for display
                dest = multiEndpoints[0].ip;
                
                // Convert multiEndpoints to profiles (with preset support)
                profiles = [];
                
                multiEndpoints.forEach(ep => {
                    if (ep.preset && presets[ep.preset]) {
                        // Endpoint has a preset selected - expand preset profiles
                        const presetData = presets[ep.preset];
                        presetData.profiles.forEach((presetProfile, idx) => {
                            // Use custom rate if this is the custom_bandwidth preset
                            const actualRate = (ep.preset === 'custom_bandwidth' && ep.custom_rate) 
                                ? ep.custom_rate 
                                : presetProfile.rate;
                            
                            profiles.push({
                                name: `${presetData.name}-${idx+1}-to-${ep.ip}`,
                                dst_ip: ep.ip,
                                dst_port: ep.port,
                                rate_mbps: actualRate,
                                protocol: presetProfile.protocol,
                                packet_size: presetProfile.packet_size,
                                dscp: presetProfile.dscp || 0,
                                enabled: true,
                                src_ip: sourceIp || null,
                                interface: sourceInterface || null,
                                measure_latency: measureLatency,
                                inject_loss_percent: injectLoss,
                                inject_latency_ms: injectLatency,
                                inject_jitter_ms: injectJitter,
                                inject_corruption_percent: injectCorruption,
                                // Copy any other preset profile fields
                                payload_pattern: presetProfile.payload_pattern || 'random',
                                burst_mode: presetProfile.burst_mode || false,
                                tcp_flags: presetProfile.tcp_flags || 'SYN'
                            });
                        });
                    } else {
                        // Simple profile - use manual configuration
                        profiles.push({
                            name: `Endpoint-${ep.id}`,
                            dst_ip: ep.ip,
                            dst_port: ep.port,
                            rate_mbps: ep.rate || 100,
                            protocol: ep.protocol || 'udp',
                            packet_size: ep.packet_size || 1400,
                            dscp: ep.dscp || 0,
                            enabled: true,
                            src_ip: sourceIp || null,
                            interface: sourceInterface || null,
                            measure_latency: measureLatency,
                            inject_loss_percent: injectLoss,
                            inject_latency_ms: injectLatency,
                            inject_jitter_ms: injectJitter,
                            inject_corruption_percent: injectCorruption
                        });
                    }
                });
            } else {
                alert('Please select a mode (Single or Multiple Endpoints)');
                return;
            }
            
            // Handle per-endpoint durations (use first endpoint's duration if set, otherwise global)
            let finalDuration = duration ? parseInt(duration) : null;
            if (multiMode && multiEndpoints.length > 0 && multiEndpoints[0].duration) {
                finalDuration = multiEndpoints[0].duration;
            }

            try {
                const res = await fetch('/api/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        test_name: testName,
                        profiles,
                        dst_ip: dest,
                        duration: finalDuration,
                        mtu,
                        enable_capture: capture,
                        impairment: {
                            loss_percent: injectLoss,
                            latency_ms: injectLatency,
                            jitter_ms: injectJitter,
                            corruption_percent: injectCorruption
                        },
                        measurement: {
                            latency: measureLatency,
                            loss_tracking: trackLoss,
                            jitter: calculateJitter
                        }
                    })
                });

                if (res.ok) {
                    isRunning = true;
                    startTimer();
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;
                    document.getElementById('generator-status').innerHTML = '<span class="status-running">ACTIVE</span>';
                    document.getElementById('dest-ip').textContent = multiMode ? `${multiEndpoints.length} endpoints` : dest;
                    document.getElementById('total-stats').style.display = 'grid';
                    if (chart) {
                        chart.data.labels = [];
                        chart.data.datasets[0].data = [];
                        chart.update();
                    }
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        };

        document.getElementById('stop-btn').onclick = async () => {
            await fetch('/api/stop', {method: 'POST'});
            isRunning = false;
            stopTimer();
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('generator-status').innerHTML = '<span class="status-stopped">OFFLINE</span>';
            loadHistory();
        };

        socket.on('connect', () => {
            document.getElementById('conn-dot').classList.remove('disconnected');
            document.getElementById('conn-text').textContent = 'CONNECTED';
        });

        socket.on('disconnect', () => {
            document.getElementById('conn-dot').classList.add('disconnected');
            document.getElementById('conn-text').textContent = 'DISCONNECTED';
        });

        socket.on('generation_stopped', () => {
            isRunning = false;
            stopTimer();
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('generator-status').innerHTML = '<span class="status-stopped">COMPLETED</span>';
            setTimeout(() => {
                document.getElementById('generator-status').innerHTML = '<span class="status-stopped">OFFLINE</span>';
            }, 3000);
            loadHistory();
        });

        socket.on('stats_update', (data) => {
            if (data.totals) {
                document.getElementById('total-mbps').textContent = data.totals.mbps.toFixed(2);
                document.getElementById('total-packets').textContent = data.totals.packets.toLocaleString();
                document.getElementById('total-pps').textContent = Math.round(data.totals.packets / (data.elapsed || 1)).toLocaleString();
                document.getElementById('total-errors').textContent = data.totals.errors;
                
                // Calculate packet loss
                const expectedPackets = data.totals.packets_sent || data.totals.packets;
                const receivedPackets = data.totals.packets_received || data.totals.packets;
                const lossPercent = expectedPackets > 0 ? ((expectedPackets - receivedPackets) / expectedPackets * 100) : 0;
                document.getElementById('total-loss').textContent = lossPercent.toFixed(2) + '%';
                document.getElementById('packet-loss').textContent = lossPercent.toFixed(2) + '%';
                
                // Average latency
                if (data.latency && data.latency.avg_ms) {
                    document.getElementById('total-latency').textContent = data.latency.avg_ms.toFixed(2) + 'ms';
                    document.getElementById('avg-latency').textContent = data.latency.avg_ms.toFixed(2) + 'ms';
                }
                
                updateChart(data.totals.mbps, data.elapsed);
            }

            if (data.profiles) {
                const grid = document.getElementById('stats-grid');
                grid.innerHTML = '';
                data.profiles.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    let latencyHtml = '';
                    if (p.latency && p.latency.samples > 0) {
                        latencyHtml = `
                            <div class="stat-row"><span>Min Latency:</span><span>${p.latency.min_ms}ms</span></div>
                            <div class="stat-row"><span>Max Latency:</span><span>${p.latency.max_ms}ms</span></div>
                            <div class="stat-row"><span>Avg Latency:</span><span>${p.latency.avg_ms}ms</span></div>
                            <div class="stat-row"><span>Jitter:</span><span>${p.latency.jitter_ms}ms</span></div>
                        `;
                    }
                    card.innerHTML = `
                        <div class="stat-profile-name">${p.name}</div>
                        <div class="stat-row"><span>Throughput:</span><span>${p.mbps.toFixed(2)} Mbps</span></div>
                        <div class="stat-row"><span>PPS:</span><span>${p.pps.toLocaleString()}</span></div>
                        <div class="stat-row"><span>Packets:</span><span>${p.packets.toLocaleString()}</span></div>
                        <div class="stat-row"><span>Errors:</span><span>${p.errors}</span></div>
                        ${latencyHtml}
                    `;
                    grid.appendChild(card);
                });
            }
        });

        async function getStatus() {
            try {
                const res = await fetch('/api/status');
                if (!res.ok) {
                    console.error('Failed to get status:', res.status);
                    return;
                }
                const status = await res.json();
                const sourceIpEl = document.getElementById('source-ip');
                if (sourceIpEl) {
                    sourceIpEl.textContent = status.source_ip || 'Unknown';
                }
            } catch (error) {
                console.error('Error getting status:', error);
                const sourceIpEl = document.getElementById('source-ip');
                if (sourceIpEl) {
                    sourceIpEl.textContent = 'Error';
                }
            }
        }

        async function loadSavedProfiles() {
            const res = await fetch('/api/profiles');
            const profiles = await res.json();
            const list = document.getElementById('saved-profiles-list');
            if (profiles.length === 0) {
                list.innerHTML = '<div style="color:var(--text-dim);padding:20px;text-align:center;">No saved profiles</div>';
                return;
            }
            list.innerHTML = '';
            profiles.forEach(p => {
                const div = document.createElement('div');
                div.className = 'saved-profile-item';
                div.innerHTML = `
                    <div class="saved-profile-name">${p.name}</div>
                    <div class="saved-profile-desc">${p.description || ''}</div>
                    <div class="saved-profile-actions">
                        <button class="btn-small" onclick="loadProfile(${p.id})">Load</button>
                        <button class="btn-small danger" onclick="deleteProfile(${p.id})">Delete</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        async function loadProfile(id) {
            const res = await fetch('/api/profiles');
            const profiles = await res.json();
            const profile = profiles.find(p => p.id === id);
            if (profile) {
                const config = JSON.parse(profile.config);
                if (config.destination) document.getElementById('destination').value = config.destination;
                if (config.mtu) document.getElementById('mtu').value = config.mtu;
                if (config.duration) document.getElementById('duration').value = config.duration;
                alert('Profile loaded');
            }
        }

        async function deleteProfile(id) {
            if (confirm('Delete profile?')) {
                await fetch(`/api/profiles/${id}`, {method: 'DELETE'});
                loadSavedProfiles();
            }
        }

        async function loadHistory() {
            const res = await fetch('/api/history?limit=20');
            const history = await res.json();
            const list = document.getElementById('history-list');
            if (history.length === 0) {
                list.innerHTML = '<div style="color:var(--text-dim);padding:20px;text-align:center;">No history</div>';
                return;
            }
            list.innerHTML = '';
            history.forEach(t => {
                const div = document.createElement('div');
                div.className = 'history-item';
                const date = new Date(t.completed_at).toLocaleString();
                div.innerHTML = `
                    <div class="history-name">${t.name || 'Test'}</div>
                    <div class="history-time">${date}</div>
                    <div class="history-stats">
                        <div>üìä ${(t.total_mbps||0).toFixed(2)} Mbps</div>
                        <div>üì¶ ${(t.total_packets||0).toLocaleString()}</div>
                        <div>‚è±Ô∏è ${t.duration||'‚àû'}s</div>
                        <div>üéØ ${t.destination}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        async function loadAdvancedFeatures() {
            try {
                const res = await fetch('/api/advanced/features');
                advancedFeatures = await res.json();
            } catch (e) {
                console.error('Failed to load advanced features:', e);
            }
        }

        async function checkCoordinator() {
            try {
                const res = await fetch('/api/coordinator/status');
                const status = await res.json();
                const statusDiv = document.getElementById('coordinator-status');
                if (status.enabled && status.connected) {
                    statusDiv.innerHTML = `‚úÖ Connected to ${status.url}<br>Instance: ${status.instance_id}`;
                    statusDiv.style.color = 'var(--success)';
                    loadClusters();
                } else if (status.enabled) {
                    statusDiv.innerHTML = `‚ö†Ô∏è Coordinator configured but not connected<br>${status.url}`;
                    statusDiv.style.color = 'var(--warning)';
                } else {
                    statusDiv.innerHTML = '‚ùå No coordinator configured';
                    statusDiv.style.color = 'var(--text-dim)';
                }
            } catch (e) {
                console.error('Failed to check coordinator:', e);
            }
        }

        async function loadInterfaces() {
            try {
                const res = await fetch('/api/interfaces');
                const data = await res.json();
                
                if (!data.success) {
                    document.getElementById('interface-info').innerHTML = 
                        `<div style="color:var(--error);">‚ö†Ô∏è ${data.error}</div>`;
                    return;
                }
                
                const interfaces = data.interfaces;
                const select = document.getElementById('source-interface');
                const infoDiv = document.getElementById('interface-info');
                
                // Clear and populate select
                select.innerHTML = '<option value="">Auto-detect</option>';
                let infoHTML = '<div style="font-weight:700;margin-bottom:5px;">Available Interfaces:</div>';
                
                Object.keys(interfaces).forEach(iface => {
                    const info = interfaces[iface];
                    select.innerHTML += `<option value="${iface}">${iface}</option>`;
                    
                    infoHTML += `<div style="margin:5px 0;padding:5px;background:var(--bg-secondary);border-left:3px solid var(--accent-cyan);">`;
                    infoHTML += `<strong>${iface}:</strong><br>`;
                    
                    if (info.ipv4.length > 0) {
                        infoHTML += `<span style="color:var(--accent-cyan);">IPv4:</span> ${info.ipv4.join(', ')}<br>`;
                    }
                    if (info.ipv6.length > 0) {
                        infoHTML += `<span style="color:var(--accent-magenta);">IPv6:</span> ${info.ipv6.join(', ')}`;
                    }
                    infoHTML += `</div>`;
                });
                
                infoDiv.innerHTML = infoHTML;
            } catch (e) {
                console.error('Failed to load interfaces:', e);
                document.getElementById('interface-info').innerHTML = 
                    `<div style="color:var(--error);">‚ùå Failed to load interfaces</div>`;
            }
        }

        async function autoDetectInterface() {
            const dstIp = document.getElementById('destination').value;
            
            if (!dstIp || dstIp === '') {
                document.getElementById('auto-detect-result').style.display = 'none';
                return;
            }
            
            try {
                const res = await fetch(`/api/auto-detect-interface?dst_ip=${encodeURIComponent(dstIp)}`);
                const data = await res.json();
                
                if (data.success && data.interface) {
                    // Show auto-detection result
                    document.getElementById('auto-interface').textContent = data.interface;
                    document.getElementById('auto-source').textContent = data.source_ip;
                    document.getElementById('auto-detect-result').style.display = 'block';
                    document.getElementById('auto-detect-result').style.borderColor = 'var(--accent-cyan)';
                } else if (data.success && !data.interface) {
                    // No specific interface, using default
                    document.getElementById('auto-interface').textContent = 'Default Route';
                    document.getElementById('auto-source').textContent = data.source_ip;
                    document.getElementById('auto-detect-result').style.display = 'block';
                    document.getElementById('auto-detect-result').style.borderColor = 'var(--warning)';
                } else {
                    document.getElementById('auto-detect-result').style.display = 'none';
                }
            } catch (e) {
                console.error('Auto-detection failed:', e);
                document.getElementById('auto-detect-result').style.display = 'none';
            }
        }

        function acceptAutoDetection() {
            const iface = document.getElementById('auto-interface').textContent;
            const srcIp = document.getElementById('auto-source').textContent;
            
            if (iface && iface !== 'Default Route' && iface !== '-') {
                document.getElementById('source-interface').value = iface;
            }
            
            if (srcIp && srcIp !== '-') {
                document.getElementById('source-ip').value = srcIp;
            }
            
            // Flash success
            const result = document.getElementById('auto-detect-result');
            result.style.borderColor = 'var(--success)';
            setTimeout(() => {
                result.style.borderColor = 'var(--accent-cyan)';
            }, 500);
        }

        async function loadClusters() {
            try {
                const res = await fetch('/api/coordinator/clusters');
                const clusters = await res.json();
                const select = document.getElementById('cluster-select');
                select.innerHTML = '<option value="">Select Cluster</option>';
                clusters.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = `${c.name} (${c.online_instances || 0} online)`;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load clusters:', e);
            }
        }

        function openSaveProfileModal() {
            document.getElementById('save-modal').classList.add('active');
        }

        function closeSaveModal() {
            document.getElementById('save-modal').classList.remove('active');
        }

        async function saveProfile() {
            const name = document.getElementById('profile-name').value;
            const desc = document.getElementById('profile-desc').value;
            if (!name) {
                alert('Enter name');
                return;
            }
            const config = {
                preset: currentPreset,
                destination: document.getElementById('destination').value,
                duration: document.getElementById('duration').value,
                mtu: document.getElementById('mtu').value
            };
            await fetch('/api/profiles', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, description: desc, config})
            });
            closeSaveModal();
            loadSavedProfiles();
            document.getElementById('profile-name').value = '';
            document.getElementById('profile-desc').value = '';
        }

        function openSettingsModal() {
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function saveSettings() {
            closeSettingsModal();
        }

        async function openFeaturesModal() {
            document.getElementById('features-modal').classList.add('active');
            const content = document.getElementById('features-content');
            
            try {
                const res = await fetch('/api/advanced/features');
                const features = await res.json();
                
                let html = '<div style="display:grid;gap:15px;">';
                html += `<div style="padding:15px;background:var(--bg-primary);border:1px solid var(--border);">`;
                html += `<div style="font-weight:700;color:var(--accent-cyan);margin-bottom:10px;">Advanced Features: ${features.enabled ? '‚úÖ ENABLED' : '‚ùå DISABLED'}</div>`;
                html += `<div style="display:grid;gap:5px;font-size:0.8rem;">`;
                html += `<div>‚Ä¢ Custom Payloads: ${features.features.custom_payloads ? '‚úÖ' : '‚ùå'}</div>`;
                html += `<div>‚Ä¢ Burst Mode: ${features.features.burst_mode ? '‚úÖ' : '‚ùå'}</div>`;
                html += `<div>‚Ä¢ Latency Measurement: ${features.features.latency_measurement ? '‚úÖ' : '‚ùå'}</div>`;
                html += `<div>‚Ä¢ TCP Flags Control: ${features.features.tcp_flags ? '‚úÖ' : '‚ùå'}</div>`;
                html += `<div>‚Ä¢ HTTP Protocol: ${features.features.http_protocol ? '‚úÖ' : '‚ùå'}</div>`;
                html += `<div>‚Ä¢ DNS Protocol: ${features.features.dns_protocol ? '‚úÖ' : '‚ùå'}</div>`;
                html += `</div></div>`;
                
                html += `<div style="padding:15px;background:var(--bg-primary);border:1px solid var(--border);">`;
                html += `<div style="font-weight:700;color:var(--accent-magenta);margin-bottom:10px;">Network Impairment</div>`;
                html += `<div style="font-size:0.8rem;">`;
                html += `<div>‚Ä¢ Packet Loss Injection: ‚úÖ Available</div>`;
                html += `<div>‚Ä¢ Latency Injection: ‚úÖ Available</div>`;
                html += `<div>‚Ä¢ Jitter Injection: ‚úÖ Available</div>`;
                html += `<div>‚Ä¢ Corruption Injection: ‚úÖ Available</div>`;
                html += `</div></div>`;
                
                html += `<div style="padding:15px;background:var(--bg-primary);border:1px solid var(--border);">`;
                html += `<div style="font-weight:700;color:var(--accent-yellow);margin-bottom:10px;">Coordinator</div>`;
                html += `<div style="font-size:0.8rem;">`;
                html += `<div>Status: ${features.coordinator.enabled ? (features.coordinator.connected ? '‚úÖ Connected' : '‚ö†Ô∏è Configured but not connected') : '‚ùå Not configured'}</div>`;
                if (features.coordinator.enabled) {
                    html += `<div>URL: ${features.coordinator.url}</div>`;
                }
                html += `</div></div>`;
                
                html += '</div>';
                content.innerHTML = html;
            } catch (e) {
                content.innerHTML = '<p style="color:var(--error);">Failed to load features: ' + e.message + '</p>';
            }
        }

        function closeFeaturesModal() {
            document.getElementById('features-modal').classList.remove('active');
        }

        async function exportHistory(format) {
            window.location.href = `/api/history/export/${format}`;
        }
    </script>
</body>
</html>
